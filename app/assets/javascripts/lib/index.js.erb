

$(function() { 

  // setup buttons
  $("#invite-cta").click(showInviteRequestField);
  $("#invite-submit").click(showInviteSurvey);
  $(".signup-survey button").click(function(e){showInviteConfirmation(e);});

  // mailcheck
  $("input[name='email']").on('blur', function() {
    $(this).mailcheck({
    
      topLevelDomains: ["com", "net", "org", "aero"],

      // when there is a suggestion...
      suggested: function(element, suggestion) {
      
        // if entry is available and passes simple regex
        if (validated()) {
        
          // show suggestions
          var suggestion_msg;
          suggestion_msg = "Did you mean ";
          suggestion_msg += "<a href='#' id='mailcheck-suggestion'>" + suggestion.full + "</a>?";

          $("#send-error").removeClass("error");
          $("#send-error").html(suggestion_msg);
          $("#send-error").slideDown(200);          
        
        }
        
      }
      
    });
    
  });

  // handle mailcheck suggestion link click
  $("body").on("click", "#mailcheck-suggestion", function() {
     
      // set the email field to the suggestion
      var suggestion = $(this).html();
      $("input[name='email']").val(suggestion);
    
      // hide suggestion message
      $("#send-error").slideUp(200);

  });  
  
});


function showInviteConfirmation(e) {

  element = (e.target) ? e.target : e.currentTarget
  mixpanel.track("Survey Response Entered", {"value": $(element).html() })

  $(".signup-survey").fadeOut(200, function(){
    $(".signup-confirmation").fadeIn(300);
  });

  $("#hero-headline").fadeOut(200, function(){
    $("#hero-headline h1").html("Thanks!");
    $("#hero-headline").fadeIn(300);
  });    

}

function showInviteSurvey() {

  if (validated()) {

    var email = $("input[name='email']").val();

    mixpanel.track("Entered Email", {"valid": "true"});
    mixpanel.name_tag(email);  

    $.post("/r", {email: email }, function(data){

      mixpanel.people.identify(data.token);    
      
      if (data.new) { mixpanel.alias(data.token); }
         
    }, 'json');

    $(".signup-form").fadeOut(200, function(){
      $(".signup-survey").fadeIn(300);
    });

    $("#hero-headline").fadeOut(200, function(){
      $("#hero-headline h1").html("You're on the List!");
      $("#hero-headline").fadeIn(300);
    });      

  } else {

    mixpanel.track("Entered Email", {"valid": "false"});

    $("#send-error").addClass("error");
    $("#send-error").html("Sorry, we can't send to the address you entered.");
    $("#send-error").slideDown(200);

  }

}

function showInviteRequestField() {

  mixpanel.track("Clicked Invite Request");

  $(".signup-intro").fadeOut(200, function(){
    $(".signup-form").fadeIn(300);
  });

  $("#hero-headline").fadeOut(200, function(){
    $("#hero-headline h1").html("Signup for an invite and be the first to try JetDeck");
    $("#hero-headline").fadeIn(300);
  });    

}

function validated() {

  var email = $("input[name='email']").val();
  if (email == "") return false;
  
  var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;   
  
  return re.test(email);

}

